---
title: "UKAlc_Daily_Cleaning"
author: "Anna Patterson"
date: "2023-09-28"
output: html_document
---

# This rmd entails the cleaning process for the daily participant surveys

rm(list = ls())
```{r}
#libraries
library(tidyverse)
library(dplyr)
library(tidyr)
library(stringr)
library(janitor)
library(lubridate)
library(lme4)
library(nlme)
library(lmerTest) #to extract P values when lmer doesnt feel like showing them
library(performance) #to extract ICCs
library(emmeans) #for plotting interactions
knitr::opts_chunk$set(echo = TRUE)
library(ggpubr)
library(ggplot2)
library(ggdist)
library(readxl)


#Anisha's Paths

# 
# am_qual <- read.csv("C:/Users/anish/Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/UKALC/02_datasets/UKALC_DAILY/02_data_prep_workspace/AM_Qualtrics_csv.csv")
# 
# pm_qual <- read.csv("C:/Users/anish/Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/UKALC/02_datasets/UKALC_DAILY/02_data_prep_workspace/PM_Qualtrics_csv.csv")
# 
# am_rc <- read.csv("C:/Users/anish/Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/UKALC/02_datasets/UKALC_DAILY/02_data_prep_workspace/AM_REDCap_csv.csv")
# 
# pm_rc <- read.csv("C:/Users/anish/Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/UKALC/02_datasets/UKALC_DAILY/02_data_prep_workspace/PM_REDCap_csv.csv")


#Mac Paths 

am_qual <- read.csv("~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/UKALC/02_datasets/UKALC_DAILY/02_data_prep_workspace/AM_Qualtrics_csv.csv")

pm_qual <- read.csv("~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/UKALC/02_datasets/UKALC_DAILY/02_data_prep_workspace/PM_Qualtrics_csv.csv")

am_rc <- read.csv("~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/UKALC/02_datasets/UKALC_DAILY/02_data_prep_workspace/AM_REDCap_csv.csv")

pm_rc <- read.csv("~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/UKALC/02_datasets/UKALC_DAILY/02_data_prep_workspace/PM_REDCap_csv.csv")
```

IDs in am_qual: 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 126

IDss in am_rc: [1] "123"       "124"       "125"       "125b"      "125c"      "125d"      "127"       "127 (new)" "128"      
[10] "129"       "130"       "131"       "132"       "133"       "134"       "134b"      "135"       "136"      
[19] "138"       "139"       "139b"      "140"       "141"       "142"       "142b"      "143"       "144"      
[28] "145"       "146"       "147"       "148"       "149"       "150"       "152"       "153"       "154"      
[37] "155"       "156"       "157"       "158"       "159"       "160"       "161"       "162"       "163"      
[46] "164"       "165"       "166"       "166a"      "166b"      "167"       "168"       "169"       "170"      
[55] "171"       "172"       "173"       "174"       "175"       "176"       "177"       "178"       "179"      
[64] "180"       "181"       "182"       "183"       "184"       "185"   

IDs in pm_qual: 101 102 103 104 105 106 107 108 109 111 112 113 114 115 116 117 118 119 120 121 122 126 

IDs in pm_rc: [1] "123"       "124"       "125"       "125b"      "125c"      "125d"      "127"       "127 (new)" "128"      
[10] "129"       "130"       "131"       "132"       "133"       "134"       "134b"      "135"       "136"      
[19] "138"       "139"       "139b"      "140"       "141"       "142"       "142b"      "143"       "144"      
[28] "145"       "146"       "147"       "148"       "149"       "150"       "152"       "153"       "154"      
[37] "155"       "156"       "157"       "158"       "159"       "160"       "161"       "162"       "163"      
[46] "164"       "165"       "166"       "166a"      "166b"      "167"       "168"       "169"       "170"      
[55] "171"       "172"       "173"       "174"       "175"       "176"       "177"       "178"       "179"      
[64] "180"       "181"       "182"       "183"       "184"       "185"    


# Merge qualtrics and redcap datasets by am and pm 
## IDs in am qualtrics are numerical, IDs in rc are string form -- letters at end of some IDs indicate different sessions of same participant 
```{r}
am_data <- merge(am_qual, am_rc, by = c("ID", "DateTime"), all = T)

pm_data <- merge(pm_qual, pm_rc, by = c("ID", "DateTime"), all = T)
```

# View overlap between am and pm data and see how many unique IDs are in each dataset 
```{r}
intersect(am_data$ID, pm_data$ID)

setdiff(am_data$ID, pm_data$ID)

am_pm_part <- intersect(am_data$ID, pm_data$ID)
length(am_pm_part)

am_data$ID <- gsub("[^0-9.-]", "", am_data$ID)
pm_data$ID <- gsub("[^0-9.-]", "", pm_data$ID)

#seeing how many IDs are in each data set, viewed the output and saw they included NA in the calculation, so subtracted 1 from final calculation 
length(unique(am_data$ID)) # 83 unique IDs in am_data
length(unique(pm_data$ID)) # 82 unique IDs in pm_data 
# after correcting for duplicates, we have n = 78 for daily survey data 
```

# Separate datetime variable 
```{r}
am_data[c('daterated', 'time')] <- str_split_fixed(am_data$DateTime, ' ', 2)
pm_data[c('daterated', 'time')] <- str_split_fixed(pm_data$DateTime, ' ', 2)
```

# Change time character to a time-realized variable 
```{r}
pm_data$time <- lubridate::hm(pm_data$time)
pm_data$daterated <- lubridate::mdy(pm_data$daterated)
```

# Flag observations that were done before 12pm 
```{r}
pm_data <- pm_data %>% mutate(pm_data, b4noon = ifelse(time < lubridate::hm("12:00"),1, 0)) 
```

# If pm survey filled out before noon, assign to day prior 
```{r}
pm_data <- pm_data %>%
  mutate(daterated = case_when(
    b4noon == 1 ~ daterated -1,
    TRUE ~ daterated
  ))
```

# Transform daterated into a date variable and remove DateTime column 
```{r}
am_data$daterated <- lubridate::mdy(am_data$daterated)

am_data = subset(am_data, select = -c(DateTime))
```

# Replace blank responses with NA so that NA and blank are coded the same for subsequent analysis 
# Consolidate xy variable names that existed as a byproduct of merging the two datasets with the same column names
```{r}
replace_empty_with_na <- function(data) {
  data %>% mutate_if(is.character, ~ ifelse(. == "", NA, .))
}

xymerge <- function(dat) {
  # Create a logical vector indicating which column names end in ".x"
  x_cols <- grepl("\\.x$", names(dat))
  
  # Loop over each x column and apply the ifelse function
  for (x_col in names(dat)[x_cols]) {
    # Extract the corresponding y column name
    y_col <- gsub("\\.x$", ".y", x_col)
    
    # Create a new column name by removing the .x suffix
    new_col <- gsub("\\.x$", "", x_col)
    
    # Apply the ifelse function to the x and y columns and assign the result to the new column
    dat[[new_col]] <- ifelse(is.na(dat[[x_col]]), dat[[y_col]], dat[[x_col]])
    
    # Remove the x and y columns from the dataframe
    dat[[x_col]] <- NULL
    dat[[y_col]] <- NULL
  }
  
  # Return the updated data frame
  return(dat)
}
# replace empty with NA 
am_data <- replace_empty_with_na(am_data)
pm_data <- replace_empty_with_na(pm_data)
#consolidate xy variable names 
am_data <- xymerge(am_data)
pm_data <- xymerge(pm_data)
```

# Relocate daterated to be after ID and remove time column 
```{r}
am_data <- am_data %>% 
  relocate(daterated, .after = ID) 
pm_data <- pm_data %>% 
  relocate(daterated, .after = ID) 
```

# Add _am and _pm suffixes to each dataset 
```{r}
colnames(am_data) <- paste(colnames(am_data), "am", sep="_")

colnames(pm_data) <- paste(colnames(pm_data), "pm", sep="_")
```

# Rename daterated and ID to drop the _am and _pm suffixes 
```{r}
colnames(am_data)[colnames(am_data) == "daterated_am"] ="daterated"
colnames(pm_data)[colnames(pm_data) == "daterated_pm"] ="daterated"

colnames(am_data)[colnames(am_data) == "ID_am"] ="ID"
colnames(pm_data)[colnames(pm_data) == "ID_pm"] ="ID"
```

# Remove rows where everything is NA except daterated, time, and ID
```{r}
am_data <- am_data %>% drop_na(daterated, ID)
pm_data <- pm_data %>% drop_na(daterated, ID)
```

# Remove X_pm column from pm_data 
```{r}
pm_data = subset(pm_data, select=-c(X_pm))
```

# Drop ID 127 per Annie Griffith's recommendation (not much data for this ID)
```{r}
am_data <- subset(am_data, ID != 127)

pm_data <- subset(pm_data, ID != 127)
```

# Find Duplicates in Dates per ID for am_data
```{r}
result.am <- am_data %>%
  group_by(ID, daterated) %>%
  summarise(observations = n())

dupdate_am <- subset(result.am, observations != 1)
dupdate_am

result.pm <- pm_data %>%
  group_by(ID, daterated) %>%
  summarise(observations = n())

dupdate_pm <- subset(result.pm, observations != 1)
dupdate_pm
```

# Remove am_data rows so that we no longer have >1 submission per am or pm data per date. Kept earliest timestamp if all submissions are identical, or kept most complete form if some are more completed than others. 
```{r}
#remove duplicates for 106 on 2021-05-09 
am_data %>%
  filter(ID == 106 & daterated == ymd("2021-05-09"))

am_data <- am_data[!(am_data$ID == 106 & am_data$daterated == "2021-05-09" & am_data$time_am == "10:02"), ]
am_data <- am_data[!(am_data$ID == 106 & am_data$daterated == "2021-05-09" & am_data$time_am == "9:59"), ]

#remove duplicates for 106 on 2021-05-18 
am_data <- am_data[!(am_data$ID == 106 & am_data$daterated == "2021-05-18" & am_data$time_am == "6:35"), ]

#remove duplicates for 106 on 2021-05-20 
am_data <- am_data[!(am_data$ID == 106 & am_data$daterated == "2021-05-20" & am_data$time_am == "4:50"), ]

#remove duplicates for 106 on 2021-05-24 
am_data <- am_data[!(am_data$ID == 106 & am_data$daterated == "2021-05-24" & am_data$time_am == "21:59"), ]
am_data <- am_data[!(am_data$ID == 106 & am_data$daterated == "2021-05-24" & am_data$time_am == "22:00"), ]
am_data <- am_data[!(am_data$ID == 106 & am_data$daterated == "2021-05-24" & am_data$time_am == "22:02"), ]

#remove duplicates for 112 on 2021-06-28 
am_data <- am_data[!(am_data$ID == 112 & am_data$daterated == "2021-06-28" & am_data$time_am == "4:58"), ]

#remove duplicates for 112 on 2021-07-11
am_data <- am_data[!(am_data$ID == 112 & am_data$daterated == "2021-07-11" & am_data$time_am == "18:38"), ] 

#remove duplicates for 113 on 2021-06-23 
am_data <- am_data[!(am_data$ID == 113 & am_data$daterated == "2021-06-23" & am_data$time_am == "14:34"), ] 

#remove duplicates for 113 on 2021-07-07 
am_data <- am_data[!(am_data$ID == 113 & am_data$daterated == "2021-07-07" & am_data$time_am == "11:57"), ] 

#remove duplicates for 113 on 2021-07-21
am_data <- am_data[!(am_data$ID == 113 & am_data$daterated == "2021-07-21" & am_data$time_am == "11:12"), ] 

#remove duplicates for 114 on 2021-06-29
am_data <- am_data[!(am_data$ID == 114 & am_data$daterated == "2021-06-29" & am_data$time_am == "22:00"), ] 

#remove duplicates for 114 on 2021-07-01 
am_data <- am_data[!(am_data$ID == 114 & am_data$daterated == "2021-07-01 " & am_data$time_am == "9:33"), ] 

#remove duplicates for 114 on 2021-07-04 
am_data <- am_data[!(am_data$ID == 114 & am_data$daterated == "2021-07-04" & am_data$time_am == "5:58"), ] 

#remove duplicates for 114 on 2021-07-06
am_data <- am_data[!(am_data$ID == 114 & am_data$daterated == "2021-07-06" & am_data$time_am == "4:52"), ] 

#remove duplicates for 114 on 2021-07-09 
am_data <- am_data[!(am_data$ID == 114 & am_data$daterated == "2021-07-09" & am_data$time_am == "21:44"), ] 
am_data <- am_data[!(am_data$ID == 114 & am_data$daterated == "2021-07-09" & am_data$time_am == "21:45"), ] 

#remove duplicates for 114 on 2021-07-15
am_data <- am_data[!(am_data$ID == 114 & am_data$daterated == "2021-07-15" & am_data$time_am == "7:44"), ] 

#remove duplicates for 115 on 2021-06-24 
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-06-24" & am_data$time_am == "6:52"), ] 

#remove duplicates for 115 on 2021-06-27
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-06-27" & am_data$time_am == "8:27"), ] 

#remove duplicates for 115 on 2021-07-01
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-07-01" & am_data$time_am == "19:53"), ] 

#remove duplicates for 115 on 2021-07-04
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-07-04" & am_data$time_am == "3:00"), ] 
#remove duplicates for 115 on 2021-07-09 
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-07-09" & am_data$time_am == "21:49"), ] 
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-07-09" & am_data$time_am == "21:52"), ] 
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-07-09" & am_data$time_am == "21:55"), ] 
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-07-09" & am_data$time_am == "22:01"), ] 

#remove duplicates for 115 on 2021-07-11
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-07-11" & am_data$time_am == "8:38"), ] 
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-07-11" & am_data$time_am == "8:41"), ] 

#remove duplicates for 115 on 2021-07-20 
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-07-20" & am_data$time_am == "6:50"), ] 
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-07-20" & am_data$time_am == "6:57"), ] 
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-07-20" & am_data$time_am == "7:00"), ] 
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-07-20" & am_data$time_am == "7:04"), ] 
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-07-20" & am_data$time_am == "7:06"), ] 
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-07-20" & am_data$time_am == "7:09"), ] 
am_data <- am_data[!(am_data$ID == 115 & am_data$daterated == "2021-07-20" & am_data$time_am == "7:13"), ]

#remove duplicates for 118 on 2021-08-08
am_data <- am_data[!(am_data$ID == 118 & am_data$daterated == "2021-08-08" & am_data$time_am == "12:29"), ] 

#remove duplicates for 119 on 2021-08-27
am_data <- am_data[!(am_data$ID == 119 & am_data$daterated == "2021-08-27" & am_data$time_am == "21:42"), ] 

#remove duplicates for 123 on 2021-08-31
am_data <- am_data[!(am_data$ID == 123 & am_data$daterated == "2021-08-31" & am_data$time_am == "5:05"), ] 

#remove duplicates for 131 on 2021-10-17 
am_data <- am_data[!(am_data$ID == 131 & am_data$daterated == "2021-10-17" & am_data$time_am == "22:16"), ] 

#remove duplicates for ID 136 on 2021-11-29 
am_data <- am_data[!(am_data$ID == 136 & am_data$daterated == "2021-11-29" & am_data$time_am == "12:56"), ] 

#remove duplicates for ID 141 on 2022-02-01
am_data <- am_data[!(am_data$ID == 141 & am_data$daterated == "2022-02-01" & am_data$time_am == "7:30"), ] 
#remove duplicates for ID 149 on 2022-06-13
am_data <- am_data[!(am_data$ID == 149 & am_data$daterated == "2022-06-13" & am_data$time_am == "13:57"), ] 

#remove duplicates for ID 159 on 2022-07-17
am_data <- am_data[!(am_data$ID == 159 & am_data$daterated == "2022-07-17" & am_data$time_am == "9:59"), ] 

#remove duplicates for ID 159 on 2022-08-05
am_data <- am_data[!(am_data$ID == 159 & am_data$daterated == "2022-08-05" & am_data$time_am == "9:59"), ] 

#remove duplicates for ID 161 on 2022-08-12
am_data <- am_data[!(am_data$ID == 161 & am_data$daterated == "2022-08-12" & am_data$time_am == "6:30"), ] 

#remove duplicates for ID 166 on 2022-09-15
am_data <- am_data[!(am_data$ID == 166 & am_data$daterated == "2022-09-15" & am_data$time_am == "10:52"), ] 

#remove duplicates for 171 on 2022-10-21 
am_data <- am_data[!(am_data$ID == 171 & am_data$daterated == "2022-10-21" & am_data$time_am == "13:03"), ] 

#remove duplicates for 180 on 2023-03-26
am_data <- am_data[!(am_data$ID == 180 & am_data$daterated == "2023-03-26" & am_data$time_am == "2:42"), ] 

#remove duplicates for 181 on 2023-03-22
am_data <- am_data[!(am_data$ID == 181 & am_data$daterated == "2023-03-22" & am_data$time_am == "13:46"), ] 
```

# Remove pm_data rows so that we no longer have >1 submission per am or pm data per date. Kept earliest timestamp if all submissions are identical, or kept most complete form if some are more completed than others.
```{r}
#use this code to filter data pm_data %>%
  #filter(ID == x & daterated == ymd("x"))
#ID 106
pm_data <- pm_data[!(pm_data$ID == 106 & pm_data$daterated == "2021-05-08" & pm_data$time_pm == "10H 0M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 106 & pm_data$daterated == "2021-05-13" & pm_data$time_pm == "4H 57M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 106 & pm_data$daterated == "2021-05-19" & pm_data$time_pm == "4H 52M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 106 & pm_data$daterated == "2021-05-22" & pm_data$time_pm == "10H 32M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 106 & pm_data$daterated == "2021-05-23" & pm_data$time_pm == "13H 8M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 106 & pm_data$daterated == "2021-05-24" & pm_data$time_pm == "7H 18M 0S"), ]
#ID 107
pm_data <- pm_data[!(pm_data$ID == 107 & pm_data$daterated == "2021-05-29" & pm_data$time_pm == "7H 18M 0S"), ]

#ID 109 
pm_data <- pm_data[!(pm_data$ID == 109 & pm_data$daterated == "2021-06-22" & pm_data$time_pm == "20H 30M 0S"), ]

#ID 113 
pm_data <- pm_data[!(pm_data$ID == 113 & pm_data$daterated == "2021-06-29" & pm_data$time_pm == "21H 25M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 113 & pm_data$daterated == "2021-07-02" & pm_data$time_pm == "23H 03M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 113 & pm_data$daterated == "2021-07-05" & pm_data$time_pm == "0H 21M 0S"), ]
#ID 114
pm_data <- pm_data[!(pm_data$ID == 114 & pm_data$daterated == "2021-07-03" & pm_data$time_pm == "5H 57M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 114 & pm_data$daterated == "2021-07-05" & pm_data$time_pm == "4H 46M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 114 & pm_data$daterated == "2021-07-09" & pm_data$time_pm == "21H 43M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 114 & pm_data$daterated == "2021-07-09" & pm_data$time_pm == "21H 44M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 114 & pm_data$daterated == "2021-07-11" & pm_data$time_pm == "20H 46M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 114 & pm_data$daterated == "2021-07-14" & pm_data$time_pm == "7H 48M 0S"), ]
#ID 115 
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-06-26" & pm_data$time_pm == "8H 20M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-06-28" & pm_data$time_pm == "22H 1M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-07-01" & pm_data$time_pm == "19H 52M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-07-03" & pm_data$time_pm == "3H 5M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-07-09" & pm_data$time_pm == "21H 52M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-07-09" & pm_data$time_pm == "21H 54M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-07-09" & pm_data$time_pm == "21H 57M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-07-10" & pm_data$time_pm == "8H 37M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-07-10" & pm_data$time_pm == "8H 40M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-07-19" & pm_data$time_pm == "6H 48M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-07-19" & pm_data$time_pm == "6H 56M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-07-19" & pm_data$time_pm == "6H 59M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-07-19" & pm_data$time_pm == "7H 3M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-07-19" & pm_data$time_pm == "7H 6M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-07-19" & pm_data$time_pm == "7H 8M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-07-19" & pm_data$time_pm == "7H 10M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 115 & pm_data$daterated == "2021-07-19" & pm_data$time_pm == "7H 12M 0S"), ]

#ID 118 
pm_data <- pm_data[!(pm_data$ID == 118 & pm_data$daterated == "2021-08-08" & pm_data$time_pm == "12H 26M 0S"), ]
#ID 119 
pm_data <- pm_data[!(pm_data$ID == 119 & pm_data$daterated == "2021-08-03" & pm_data$time_pm == "21H 58M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 119 & pm_data$daterated == "2021-08-08" & pm_data$time_pm == "20H 50M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 119 & pm_data$daterated == "2021-08-13" & pm_data$time_pm == "5H 37M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 119 & pm_data$daterated == "2021-08-20" & pm_data$time_pm == "23H 28M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 119 & pm_data$daterated == "2021-08-22" & pm_data$time_pm == "5H 40M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 119 & pm_data$daterated == "2021-08-24" & pm_data$time_pm == "16H 23M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 119 & pm_data$daterated == "2021-08-27" & pm_data$time_pm == "21H 40M 0S"), ]
#ID 136
pm_data <- pm_data[!(pm_data$ID == 136 & pm_data$daterated == "2021-11-29" & pm_data$time_pm == "17H 10M 0S"), ]
#ID 138
pm_data <- pm_data[!(pm_data$ID == 138 & pm_data$daterated == "2022-02-06" & pm_data$time_pm == "12H 21M 0S"), ]
#ID 143
pm_data <- pm_data[!(pm_data$ID == 143 & pm_data$daterated == "2022-01-31" & pm_data$time_pm == "17H 04M 0S"), ]
#ID 149
pm_data <- pm_data[!(pm_data$ID == 149 & pm_data$daterated == "2022-05-25" & pm_data$time_pm == "0H 42M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 149 & pm_data$daterated == "2022-06-10" & pm_data$time_pm == "12H 20M 0S"), ]
#ID 150
pm_data <- pm_data[!(pm_data$ID == 150 & pm_data$daterated == "2022-06-07" & pm_data$time_pm == "21H 34M 0S"), ]
#ID 153
pm_data <- pm_data[!(pm_data$ID == 153 & pm_data$daterated == "2022-06-23" & pm_data$time_pm == "8H 24M 0S"), ]
#ID 159
pm_data <- pm_data[!(pm_data$ID == 159 & pm_data$daterated == "2022-07-17" & pm_data$time_pm == "6H 40M 0S"), ]
#ID 168
pm_data <- pm_data[!(pm_data$ID == 168 & pm_data$daterated == "2022-09-25" & pm_data$time_pm == "20H 23M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 168 & pm_data$daterated == "2022-10-09" & pm_data$time_pm == "18H 47M 0S"), ]
#ID 171
pm_data <- pm_data[!(pm_data$ID == 171 & pm_data$daterated == "2022-10-07" & pm_data$time_pm == "0H 10M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 171 & pm_data$daterated == "2022-10-13" & pm_data$time_pm == "12H 34M 0S"), ]
pm_data <- pm_data[!(pm_data$ID == 171 & pm_data$daterated == "2022-10-31" & pm_data$time_pm == "20H 36M 0S"), ]
#ID 180
pm_data <- pm_data[!(pm_data$ID == 180 & pm_data$daterated == "2023-04-15" & pm_data$time_pm == "22H 7M 0S"), ]
#ID 181
pm_data <- pm_data[!(pm_data$ID == 181 & pm_data$daterated == "2023-03-22" & pm_data$time_pm == "19H 13M 0S"), ]
#ID 185
pm_data <- pm_data[!(pm_data$ID == 185 & pm_data$daterated == "2023-05-29" & pm_data$time_pm == "23H 34M 0S"), ]
```

# Create new column for presence or absence of drinking in am dataset 
```{r}
am_data <- am_data %>%
  mutate(drink_today_am = ifelse(Alc_Amt_am == 0, 0, 1)) 
```

# Create new column for presence or absence of heavy drinking (> or eq to 4 in one day) in am dataset 
```{r}
am_data <- am_data %>%
  mutate(heavy_drink_am = ifelse(Alc_Amt_am >= 4, 1, 0))
```

# Identify how many people drank alcohol throughout the study 
```{r}
summary_Alc_daily <- am_data %>% group_by(ID) %>% 
  summarize(drink_today_am = n(),
            TotalDrinkingDays = sum(drink_today_am, na.rm = TRUE),
            MinDrinksperDay = min(Alc_Amt_am, na.rm = TRUE),
            MaxDrinksperDay = max(Alc_Amt_am, na.rm = TRUE),
            MeanDrinksperDay = mean(Alc_Amt_am, na.rm = TRUE)) %>%
  arrange(drink_today_am)

summary_Alc_daily
##COUNTS
summary_Alc_daily %>% tally() #all 78 participants drank alcohol 
summary_Alc_daily %>% tally(TotalDrinkingDays ==0) #no participants drank no alcohol 

## number of ppl w at least one binge-drink day (>=4 drinks on one day) = 68
am_data$Alc_Amt_am <- as.numeric(am_data$Alc_Amt_am)
am_data %>% group_by(ID) %>% 
  filter(Alc_Amt_am >= 4) 
```

# AM Data person means, person deviations and 3 day rolling avg 
```{r echo=T}
#create person means

#step 1: make variables numeric that aren't already 
am_data$Alc_Drunk_am <- as.numeric(am_data$Alc_Drunk_am)
am_data$Crav_Alc_am <- as.numeric(am_data$Crav_Alc_am)
am_data$Crav_Nic_am <- as.numeric(am_data$Crav_Nic_am)
am_data$Crav_Mar_am <- as.numeric(am_data$Crav_Mar_am)
am_data$Crav_Coc_am <- as.numeric(am_data$Crav_Coc_am)
am_data$Crav_Benz_am <- as.numeric(am_data$Crav_Benz_am)
am_data$Crav_Hall_am <- as.numeric(am_data$Crav_Hall_am)
am_data$Crav_Opiate_am <- as.numeric(am_data$Crav_Opiate_am)
am_data$Crav_Opiate_am <- as.numeric(am_data$ID)

#Create person means   
am_data <- am_data %>% group_by(ID) %>% mutate(Urg_Alc_am.m = mean(Urg_Alc_am, na.rm = T),
                                              Urg_Nic_am.m = mean(Urg_Nic_am, na.rm = T),
                                               Urg_Mar_am.m = mean(Urg_Mar_am, na.rm = T),
                                               Urg_Coc_am.m = mean(Urg_Coc_am, na.rm = T),
                                               Urg_Oth_am.m = mean(Urg_Oth_am, na.rm = T),
                                               Crav_Alc_am.m = mean(Crav_Alc_am, na.rm = T),
                                               Crav_Nic_am.m = mean(Crav_Nic_am, na.rm = T),
                                               Crav_Mar_am.m = mean(Crav_Mar_am, na.rm = T),
                                               Crav_Coc_am.m = mean(Crav_Coc_am, na.rm = T),
                                               Crav_Benz_am.m = mean(Crav_Benz_am, na.rm = T),
                                               Crav_Hall_am.m = mean(Crav_Hall_am, na.rm = T),
                                               Crav_Opiate_am.m = mean(Crav_Opiate_am, na.rm = T),
                                               Alc_Amt_am.m = mean(Alc_Amt_am, na.rm = T),
                                              Alc_Drunk_am.m = mean(Alc_Drunk_am, na.rm = T))

#create person-centered deviations
am_data <- am_data %>% rowwise() %>% mutate(Urg_Alc_am.d = Urg_Alc_am - Urg_Alc_am.m, na.rm = T,
                                            Urg_Nic_am.d = Urg_Nic_am - Urg_Nic_am.m, na.rm = T,
                                            Urg_Mar_am.d = Urg_Mar_am - Urg_Mar_am.m, na.rm = T,
                                            Urg_Coc_am.d = Urg_Coc_am - Urg_Coc_am.m, na.rm = T,
                                            Urg_Oth_am.d = Urg_Oth_am - Urg_Oth_am.m, na.rm = T,
                                            Crav_Alc_am.d = Crav_Alc_am - Crav_Alc_am.m, na.rm = T,
                                            Crav_Mar_am.d = Crav_Mar_am - Crav_Mar_am.m, na.rm = T,
                                            Crav_Coc_am.d = Crav_Coc_am - Crav_Coc_am.m, na.rm = T,
                                            Crav_Benz_am.d = Crav_Benz_am - Crav_Benz_am.m, na.rm = T,
                                            Crav_Hall_am.d = Crav_Hall_am - Crav_Hall_am.m, na.rm = T,
                                            Crav_Opiate_am.d = Crav_Opiate_am - Crav_Opiate_am.m, na.rm = T,
                                            Alc_Amt_am.d = Alc_Amt_am - Alc_Amt_am.m, na.rm = T,
                                            Alc_Drunk_am.d = Alc_Drunk_am - Alc_Drunk_am.m, na.rm = T)


am_vars_roll_list <- c("Urg_Alc_am", "Urg_Nic_am", "Urg_Mar_am", "Urg_Coc_am", "Urg_Oth_am", "Crav_Alc_am", "Crav_Nic_am", "Crav_Mar_am", "Crav_Coc_am", "Crav_Benz_am", "Crav_Hall_am", "Crav_Opiate_am", "Alc_Amt_am", "Alc_Drunk_am") 


#Saving function 
create.3day.rolling.avg <- function(df, var) {
   df %>%
     group_by(ID) %>%     mutate("{{var}}.roll" := rollapply({{var}}, 3,  mean, align="center", fill=NA))
}

#Rolling averages
for (i in am_vars_roll_list) {
  am_data <- create.3day.rolling.avg(am_data, !!sym({{i}}))
}

#example for how to check that the roll function worked
am_data %>% select(Urg_Alc_am, Urg_Alc_am.roll, Urg_Nic_am, Urg_Nic_am.roll, Urg_Mar_am, Urg_Mar_am.roll) %>% View()
#how to run rolling.avg fx on just 1 var at a time
am_data <- create.3day.rolling.avg(am_data, Urg_Alc_am)

```

# New column for day of week
```{r}
am_data <- am_data %>%
  mutate(DayOfWeek = wday(daterated, label = TRUE, abbr = TRUE))
##mutate DayOfWeek column to be day - 1 because they fill out survey next morning 
am_data <- am_data %>%
  mutate(PreviousDayOfWeek = (DayOfWeek - 2) %% 7 + 1) ##didn't appear to work 
pm_data <- pm_data %>%
  mutate(DayOfWeek = wday(daterated, label = TRUE, abbr = TRUE))
```
# Create Binge Drink Column
```{r}
#create binary variable for binge drink (>=4 drinks per day) 
am_data <- am_data %>%
  mutate(BingeDrink_am = ifelse(Alc_Amt_am > 4, 1, 0)) 
```

# PM data means, deviations, and rolling avg 
```{r}
#step 1: make variables numeric that aren't already 
pm_data$Diff_Inhib_pm <- as.numeric(gsub("\\D", "", pm_data$Diff_Inhib_pm))
pm_data$Diff_Change_pm <- as.numeric(gsub("\\D", "", pm_data$Diff_Change_pm))
pm_data$Diff_Stop_pm <- as.numeric(gsub("\\D", "", pm_data$Diff_Stop_pm))
pm_data$Immed_Payoff_pm <- as.numeric(gsub("\\D", "", pm_data$Immed_Payoff_pm))
pm_data$Res_Urge_pm <- as.numeric(gsub("\\D", "", pm_data$Res_Urge_pm))
pm_data$Diff_LongRew_pm <- as.numeric(gsub("\\D", "", pm_data$Diff_LongRew_pm))
pm_data$Diff_ResRew_pm <- as.numeric(gsub("\\D", "", pm_data$Diff_ResRew_pm))
pm_data$Dep_pm <- as.numeric(gsub("\\D", "", pm_data$Dep_pm))
pm_data$Hopeless_pm <- as.numeric(gsub("\\D", "", pm_data$Hopeless_pm))
pm_data$Worthless_pm <- as.numeric(gsub("\\D", "", pm_data$Worthless_pm))
pm_data$Anxious_pm <- as.numeric(gsub("\\D", "", pm_data$Anxious_pm))
pm_data$MoodSwing_pm <- as.numeric(gsub("\\D", "", pm_data$MoodSwing_pm))
pm_data$RejSens_pm <- as.numeric(gsub("\\D", "", pm_data$RejSens_pm))
pm_data$Angry_pm <- as.numeric(gsub("\\D", "", pm_data$Angry_pm))
pm_data$Conflicts_pm <- as.numeric(gsub("\\D", "", pm_data$Conflicts_pm))
pm_data$Loss_Interest_pm <- as.numeric(gsub("\\D", "", pm_data$Loss_Interest_pm))
pm_data$Diff_Conc_pm <- as.numeric(gsub("\\D", "", pm_data$Diff_Conc_pm))
pm_data$Tired_pm <- as.numeric(gsub("\\D", "", pm_data$Tired_pm))
pm_data$OverEat_pm <- as.numeric(gsub("\\D", "", pm_data$OverEat_pm))
pm_data$Sp_Food_Crav_pm <- as.numeric(gsub("\\D", "", pm_data$Sp_Food_Crav_pm))
pm_data$High_Sleep_pm <- as.numeric(gsub("\\D", "", pm_data$High_Sleep_pm))
pm_data$Diff_Sleep_pm <- as.numeric(gsub("\\D", "", pm_data$Diff_Sleep_pm))
pm_data$Overwhelm_pm <- as.numeric(gsub("\\D", "", pm_data$Overwhelm_pm))
pm_data$Loss_Control_pm <- as.numeric(gsub("\\D", "", pm_data$Loss_Control_pm))
pm_data$Breast_Tend_pm <- as.numeric(gsub("\\D", "", pm_data$Breast_Tend_pm))
pm_data$Breast_Swell_pm <- as.numeric(gsub("\\D", "", pm_data$Breast_Swell_pm))
pm_data$Headache_pm <- as.numeric(gsub("\\D", "", pm_data$Headache_pm))
pm_data$JM_Pain_pm <- as.numeric(gsub("\\D", "", pm_data$JM_Pain_pm))
pm_data$Loss_Prod_pm <- as.numeric(gsub("\\D", "", pm_data$Loss_Prod_pm))
pm_data$Int_Relat_pm <- as.numeric(gsub("\\D", "", pm_data$Int_Relat_pm))
pm_data$Urg_Alc_pm <- as.numeric(pm_data$Urg_Alc_pm)
pm_data$Urg_Nic_pm <- as.numeric(pm_data$Urg_Nic_pm)
pm_data$Urg_Mar_pm <- as.numeric(pm_data$Urg_Mar_pm)
pm_data$Urg_Coc_pm <- as.numeric(pm_data$Urg_Coc_pm)
#Create person means   
#make numerical if not already 

pm_data <- pm_data %>% group_by(ID) %>% mutate(Urg_Alc_pm.m = mean(Urg_Alc_pm, na.rm = T),
                                               Urg_Nic_pm.m = mean(Urg_Nic_pm, na.rm = T),
                                               Urg_Mar_pm.m = mean(Urg_Mar_pm, na.rm = T),
                                               Urg_Coc_pm.m = mean(Urg_Coc_pm, na.rm = T),
                                               Diff_Inhib_pm.m = mean(Diff_Inhib_pm, na.rm = T),
                                               Diff_Change_pm.m = mean(Diff_Change_pm, na.rm = T),
                                               Diff_Stop_pm.m = mean(Diff_Stop_pm, na.rm = T),
                                               Immed_Payoff_pm.m = mean(Immed_Payoff_pm, na.rm = T),
                                               Res_Urge_pm.m = mean(Res_Urge_pm, na.rm = T),
                                               Diff_LongRew_pm.m = mean(Diff_LongRew_pm, na.rm = T),
                                               Diff_ResRew_pm.m = mean(Diff_ResRew_pm, na.rm = T),
                                               Dep_pm.m = mean(Dep_pm, na.rm = T),
                                               Hopeless_pm.m = mean(Hopeless_pm, na.rm = T),
                                               Worthless_pm.m = mean(Worthless_pm, na.rm = T),
                                               Anxious_pm.m = mean(Anxious_pm, na.rm = T),
                                               MoodSwing_pm.m = mean(MoodSwing_pm, na.rm = T),
                                               RejSens_pm.m = mean(RejSens_pm, na.rm = T),
                                               Angry_pm.m = mean(Angry_pm, na.rm = T),
                                               Conflicts_pm.m = mean(Conflicts_pm, na.rm = T),
                                               Loss_Interest_pm.m = mean(Loss_Interest_pm, na.rm = T),
                                               Diff_Conc_pm.m = mean(Diff_Conc_pm, na.rm = T),
                                               Tired_pm.m = mean(Tired_pm, na.rm = T),
                                               OverEat_pm.m = mean(OverEat_pm, na.rm = T),
                                               Sp_Food_Crav_pm.m = mean(Sp_Food_Crav_pm, na.rm = T),
                                               High_Sleep_pm.m = mean(High_Sleep_pm, na.rm = T),
                                               Diff_Sleep_pm.m = mean(Diff_Sleep_pm, na.rm = T),
                                               Overwhelm_pm.m = mean(Overwhelm_pm, na.rm = T),
                                               Loss_Control_pm.m = mean(Loss_Control_pm, na.rm = T),
                                               Breast_Tend_pm.m = mean(Breast_Tend_pm, na.rm = T),
                                               Breast_Swell_pm.m = mean(Breast_Swell_pm, na.rm = T),
                                               Headache_pm.m = mean(Headache_pm, na.rm = T),
                                               JM_Pain_pm.m = mean(JM_Pain_pm, na.rm = T),
                                               Loss_Prod_pm.m = mean(Loss_Prod_pm, na.rm = T),
                                               Int_Relat_pm.m = mean(Int_Relat_pm, na.rm = T),
                                               Urg_Alc_pm.m = mean(Urg_Alc_pm, na.rm = T),
                                               Urg_Nic_pm.m = mean(Urg_Nic_pm, na.rm = T),
                                               Urg_Mar_pm.m = mean(Urg_Mar_pm, na.rm = T),
                                               Urg_Coc_pm.m = mean(Urg_Coc_pm, na.rm = T))
#create person-centered deviations 
pm_data <- pm_data %>% rowwise() %>% mutate(Urg_Alc_pm.d = Urg_Alc_pm - Urg_Alc_pm.m, na.rm = T, 
                                            Urg_Nic_pm.d = Urg_Nic_pm - Urg_Nic_pm.m, na.rm = T,
                                            Urg_Mar_pm.d = Urg_Mar_pm - Urg_Mar_pm.m, na.rm = T,
                                            Urg_Coc_pm.d = Urg_Coc_pm - Urg_Coc_pm.m, na.rm = T,
                                            Diff_Inhib_pm.d = Diff_Inhib_pm - Diff_Inhib_pm.m, na.rm = T,
                                            Diff_Change_pm.d = Diff_Change_pm - Diff_Change_pm.m, na.rm = T,
                                            Diff_Stop_pm.d = Diff_Stop_pm - Diff_Stop_pm.m, na.rm = T,
                                            Immed_Payoff_pm.d = Immed_Payoff_pm - Immed_Payoff_pm.m, na.rm = T,
                                            Res_Urge_pm.d = Res_Urge_pm - Res_Urge_pm.m, na.rm = T,
                                            Diff_LongRew_pm.d = Diff_LongRew_pm - Diff_LongRew_pm.m, na.rm = T, 
                                            Diff_ResRew_pm.d = Diff_ResRew_pm - Diff_ResRew_pm.m, na.rm = T,
                                            Dep_pm.d = Dep_pm - Dep_pm.m, na.rm = T, 
                                            Hopeless_pm.d = Hopeless_pm - Hopeless_pm.m, na.rm = T,
                                            Worthless_pm.d = Worthless_pm - Worthless_pm.m, na.rm = T,
                                            Anxious_pm.d = Anxious_pm - Anxious_pm.m, na.rm = T,
                                            MoodSwing_pm.d = MoodSwing_pm - MoodSwing_pm.m, na.rm = T,
                                            RejSens_pm.d = RejSens_pm - RejSens_pm.m, na.rm = T,
                                            Angry_pm.d = Angry_pm - Angry_pm.m, na.rm = T,
                                            Conflicts_pm.d = Conflicts_pm - Conflicts_pm.m, na.rm = T,
                                            Loss_Interest_pm.d = Loss_Interest_pm - Loss_Interest_pm.m, na.rm = T,
                                            Diff_Conc_pm.d = Diff_Conc_pm - Diff_Conc_pm.m, na.rm = T,
                                            Tired_pm.d = Tired_pm - Tired_pm.m, na.rm = T,
                                            OverEat_pm.d = OverEat_pm - OverEat_pm.m, na.rm = T,
                                            Sp_Food_Crav_pm.d = Sp_Food_Crav_pm - Sp_Food_Crav_pm.m, na.rm = T,
                                            High_Sleep_pm.d = High_Sleep_pm - High_Sleep_pm.m, na.rm = T,
                                            Diff_Sleep_pm.d = Diff_Sleep_pm - Diff_Sleep_pm.m, na.rm = T,
                                            Overwhelm_pm.d = Overwhelm_pm - Overwhelm_pm.m, na.rm = T,
                                            Loss_Control_pm.d = Loss_Control_pm - Loss_Control_pm.m, na.rm = T,
                                            Breast_Tend_pm.d = Breast_Tend_pm - Breast_Tend_pm.m, na.rm = T,
                                            Breast_Swell_pm.d = Breast_Swell_pm - Breast_Swell_pm.m, na.rm = T,
                                            Headache_pm.d = Headache_pm - Headache_pm.m, na.rm = T, 
                                            JM_Pain_pm.d = JM_Pain_pm - JM_Pain_pm.m, na.rm = T, 
                                            Loss_Prod_pm.d = Loss_Prod_pm - Loss_Prod_pm.m, na.rm = T,
                                            Int_Relat_pm.d = Int_Relat_pm - Int_Relat_pm.m, na.rm = T) 

pm_vars_roll_list <- c("Urg_Alc_pm", "Urg_Nic_pm", "Urg_Mar_pm", "Urg_Coc_pm", "Diff_Inhib_pm", "Diff_Change_pm", "Diff_Stop_pm", "Immed_Payoff_pm", "Res_Urge_pm", "Diff_LongRew_pm", "Diff_ResRew_pm", "Dep_pm", "Hopeless_pm", "Worthless_pm", "Anxious_pm", "MoodSwing_pm", "RejSens_pm", "RejSens_pm", "Angry_pm", "Conflicts_pm", "Loss_Interest_pm", "Diff_Conc_pm", "Tired_pm", "OverEat_pm", "Sp_Food_Crav_pm", "High_Sleep_pm", "Diff_Sleep_pm", "Overwhelm_pm", "Loss_Control_pm", "Breast_Tend_pm", "Breast_Swell_pm", "Headache_pm", "JM_Pain_pm", "Loss_Prod_pm", "Int_Relat_pm") 


#Saving function 
create.3day.rolling.avg <- function(df, var) {
   df %>%
     group_by(ID) %>%     mutate("{{var}}.roll" := rollapply({{var}}, 3,  mean, align="center", fill=NA))
}

#Rolling averages
for (i in pm_vars_roll_list) {
  pm_data <- create.3day.rolling.avg(pm_data, !!sym({{i}}))
}
```


# Save cleaned files as csv files
```{r}
write.csv(am_data, "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/UKALC/02_datasets/UKALC_DAILY/03_cleaned_data/am_data_cleaned_AP.csv", row.names=TRUE)

write.csv(pm_data, "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/UKALC/02_datasets/UKALC_DAILY/03_cleaned_data/pm_data_cleaned_AP.csv", row.names=TRUE)
```


